<!DOCTYPE html>
<html lang="de" prefix="og: http://ogp.me/ns#">
<head>
<link rel="stylesheet" href="cropper.min.css"/>
<script src="cropper.min.js"></script>
<style type="text/css">
	img {
		max-width: 100%;
	}
</style>
</head>
<body onLoad="onChangeThreshold()">
<canvas id="canvas" width="1024" height="768"></canvas>
<input id="slider" type="range" min="0" max="255" step="1" value="200" onChange="onChangeThreshold()"/> 
<input id="slider2" type="range" min="0" max="255" step="1" value="50" onChange="onChangeThreshold()"/>
<input id="color" type="color" value="#ffffff" onChange="onChangeThreshold()" />
<input id="color2" type="color" value="#666666" onChange="onChangeThreshold()" />
<input id="color3" type="color" value="#000000" onChange="onChangeThreshold()" />
<button onclick="canvasToImg()">Convert</button>
<button onclick="getFinalImage()">Fertiges Bild erzeugen</button>
<div id="croppedImage"></div>
<script type="text/javascript">

var cropper;

var img = new Image();
img.src = 'koala.jpg';

var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');

function onChangeThreshold(){
	threshold(document.getElementById('slider').value, document.getElementById('slider2').value, document.getElementById('color').value, document.getElementById('color2').value, document.getElementById('color3').value);
}

function hexToRgb(hex) {
    // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
    });

    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function threshold(threshold, threshold2, color, color2, color3 ){
	ctx.drawImage(img, 0, 0);
	var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
	var data = imageData.data;
	color = hexToRgb(color);
	color2 = hexToRgb(color2);
	color3 = hexToRgb(color3);
	for (var i = 0; i < data.length; i += 4) {
		var avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
		data[i]     = Math.round(avg/threshold) ? color.r : Math.round(avg/threshold2) ? color2.r : color3.r;
		data[i + 1] = Math.round(avg/threshold) ? color.g : Math.round(avg/threshold2) ? color2.g : color3.g;
		data[i + 2] = Math.round(avg/threshold) ? color.b : Math.round(avg/threshold2) ? color2.b : color3.b;
	}
	console.log( 'Image processed' );
	ctx.putImageData(imageData, 0, 0);
}

function getFinalImage(){
	var img = new Image();
	img.src = cropper.getCroppedCanvas().toDataURL();
	document.body.appendChild(img);	
}

function canvasToImg(){
	var image = new Image();
	image.src = canvas.toDataURL("image/png");
	image.id = "output";
	document.getElementById('croppedImage').appendChild(image);
	image = document.getElementById('output');
	cropper = new Cropper(image, {
		aspectRatio: 1,
		zoomable: false,
		viewMode: 1,
		crop: function(e) {
			console.log(e.detail.x);
			console.log(e.detail.y);
			console.log(e.detail.width);
			console.log(e.detail.height);
			console.log(e.detail.rotate);
			console.log(e.detail.scaleX);
			console.log(e.detail.scaleY);
		}
});
}

</script>
</body>
</html>